name: Deploy to Artifactory

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          server-id: artifactory
          server-username: ARTIFACTORY_USERNAME
          server-password: ARTIFACTORY_PASSWORD
      
      - name: Extract component from tag
        id: component
        run: |
          TAG="${{ github.event.release.tag_name }}"
          echo "Tag: $TAG"
          
          # Extract component name (e.g., security-v0.3.0 -> security)
          COMPONENT=$(echo "$TAG" | sed 's/-v[0-9].*//')
          echo "component=$COMPONENT" >> $GITHUB_OUTPUT
          echo "Deploying component: $COMPONENT"
      
      - name: Deploy security to Artifactory
        if: steps.component.outputs.component == 'security'
        run: mvn -B deploy -pl security -am -DskipTests
        env:
          ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
          ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
      
      - name: Deploy service1 to Artifactory
        if: steps.component.outputs.component == 'service1'
        run: mvn -B deploy -pl services/service1 -am -DskipTests
        env:
          ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
          ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
      
      - name: Deploy service2 to Artifactory
        if: steps.component.outputs.component == 'service2'
        run: mvn -B deploy -pl services/service2 -am -DskipTests
        env:
          ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
          ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
      
      - name: Deploy root POM to Artifactory
        if: steps.component.outputs.component == 'maven-monorepo-example'
        run: mvn -B deploy -N -DskipTests
        env:
          ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
          ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
